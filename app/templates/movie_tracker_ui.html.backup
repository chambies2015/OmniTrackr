<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>StreamTracker</title>
  <style>
    :root {
      /* Light mode colour palette */
      --bg: #f7f9fc;
      --fg: #2a2a2a;
      --card-bg: #ffffff;
      --primary: #3f51b5;
      --primary-hover: #303f9f;
      --table-header-bg: #3f51b5;
      --table-row-alt: #f2f2f2;
      --btn-radius: 4px;
    }

    body.dark-mode {
      --bg: #1e1e2f;
      --fg: #e0e0e0;
      --card-bg: #2c2c3e;
      --primary: #3949ab;
      --primary-hover: #303f9f;
      --table-header-bg: #3949ab;
      --table-row-alt: #2a2a3b;
    }

    body {
      background-image: url('./movie_theater_background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-color: var(--bg);
      color: var(--fg);
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      height: 200px;
      margin-bottom: 20px;
      border-radius: 8px;
      background-image: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('./film_background.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .header h1 {
      font-size: 3rem;
      color: #fff;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--primary);
    }

    .tab {
      padding: 12px 24px;
      background-color: var(--card-bg);
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: var(--fg);
      transition: all 0.3s ease;
    }

    .tab.active {
      background-color: var(--primary);
      color: white;
      border-bottom-color: var(--primary);
    }

    .tab:hover:not(.active) {
      background-color: var(--table-row-alt);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 6px 12px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--btn-radius);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .toggle-btn:hover {
      background-color: var(--primary-hover);
    }

    .card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    input[type="text"], input[type="number"], select {
      padding: 8px;
      margin: 4px 0;
      border: 1px solid #ccc;
      border-radius: var(--btn-radius);
      width: calc(100% - 22px);
      background-color: var(--card-bg);
      color: var(--fg);
    }
    body.dark-mode input, body.dark-mode select {
      border-color: #555;
    }

    label {
      display: inline-block;
      margin-right: 10px;
    }

    button.action-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--btn-radius);
      padding: 8px 12px;
      cursor: pointer;
      margin-right: 5px;
      margin-top: 8px;
      min-width: 80px;
    }
    button.action-btn:hover {
      background-color: var(--primary-hover);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      vertical-align: middle;
      text-align: center;
    }
    /* Make review column wider and wrap nicely */
    #movieTable th:nth-child(7),
    #movieTable td:nth-child(7) {
      width: 28%;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    /* Set practical widths for other columns */
    #movieTable th:nth-child(1),
    #movieTable td:nth-child(1) { width: 80px; }
    #movieTable th:nth-child(2),
    #movieTable td:nth-child(2) { width: 18%; }
    #movieTable th:nth-child(3),
    #movieTable td:nth-child(3) { width: 14%; }
    #movieTable th:nth-child(4),
    #movieTable td:nth-child(4) { width: 8%; }
    #movieTable th:nth-child(5),
    #movieTable td:nth-child(5) { width: 8%; }
    #movieTable th:nth-child(6),
    #movieTable td:nth-child(6) { width: 8%; }
    #movieTable th:nth-child(8),
    #movieTable td:nth-child(8) { width: 8%; }
    #movieTable th:nth-child(9),
    #movieTable td:nth-child(9) { width: 8%; }
    th {
      background-color: var(--table-header-bg);
      color: white;
    }
    tr:nth-child(even) td {
      background-color: var(--table-row-alt);
    }
    tr:hover td {
      background-color: rgba(0,0,0,0.02);
    }

    table input[type="text"],
    table input[type="number"] {
      margin: 0;
      padding: 4px;
      width: 100%;
      box-sizing: border-box;
      font: inherit;
      border: 1px solid #ccc;
      border-radius: var(--btn-radius);
    }
    table input[type="checkbox"] {
      margin: 0 auto;
      display: block;
    }

    button.action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      tr {
        margin-bottom: 10px;
      }
      td {
        border: none;
        position: relative;
        padding-left: 50%;
      }
      td:before {
        position: absolute;
        top: 12px;
        left: 6px;
        width: 45%;
        white-space: nowrap;
      }
      td:nth-of-type(1):before { content: "Poster"; }
      td:nth-of-type(2):before { content: "Title"; }
      td:nth-of-type(3):before { content: "Director"; }
      td:nth-of-type(4):before { content: "Year"; }
      td:nth-of-type(5):before { content: "Rating"; }
      td:nth-of-type(6):before { content: "Watched"; }
      td:nth-of-type(7):before { content: "Review"; }
      td:nth-of-type(8):before { content: "IMDb"; }
      td:nth-of-type(9):before { content: "Actions"; }
    }

    /* Statistics Dashboard Styles */
    .stats-section {
      margin-bottom: 30px;
      padding: 20px;
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      text-align: center;
      padding: 15px;
      background-color: var(--bg);
      border-radius: 8px;
      border: 2px solid var(--primary);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--fg);
      opacity: 0.8;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: var(--table-row-alt);
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #4caf50);
      transition: width 0.5s ease;
      border-radius: 10px;
    }

    .rating-distribution, .decade-stats {
      margin: 20px 0;
    }

    .rating-bar, .decade-bar {
      display: flex;
      align-items: center;
      margin: 8px 0;
      gap: 10px;
    }

    .rating-bar-label, .decade-bar-label {
      width: 40px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .rating-bar-fill, .decade-bar-fill {
      height: 20px;
      background-color: var(--primary);
      border-radius: 10px;
      position: relative;
      min-width: 0;
      max-width: 100%;
    }

    .rating-bar-count, .decade-bar-count {
      font-weight: bold;
      min-width: 40px;
      text-align: right;
      flex-shrink: 0;
    }

    .top-rated, .director-stats {
      margin: 20px 0;
    }

    .rated-item, .director-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin: 5px 0;
      background-color: var(--bg);
      border-radius: 6px;
      border-left: 4px solid var(--primary);
    }

    .rated-item-title, .director-name {
      font-weight: bold;
    }

    .rated-item-rating, .director-rating {
      color: var(--primary);
      font-weight: bold;
    }

    .director-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .director-column h4 {
      margin-bottom: 15px;
      color: var(--primary);
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .director-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <button id="toggleMode" class="toggle-btn">Night Mode</button>
  <div class="container">
    <div class="header">
      <h1>StreamTracker</h1>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('movies')">üé¨ Movies</button>
      <button class="tab" onclick="switchTab('tv-shows')">üì∫ TV Shows</button>
      <button class="tab" onclick="switchTab('statistics')">üìä Statistics</button>
    </div>

    <!-- Movies Tab Content -->
    <div id="movies-tab" class="tab-content active">
      <div class="card">
        <h2>Add Movie</h2>
        <form id="addMovieForm">
          <div>
            <input type="text" id="movieTitle" placeholder="Title" required>
          </div>
          <div>
            <input type="text" id="movieDirector" placeholder="Director" required>
          </div>
          <div>
            <input type="number" id="movieYear" placeholder="Year" required>
          </div>
          <div>
            <input type="number" min="0" max="10" id="movieRating" placeholder="Rating (0-10)">
          </div>
          <div>
            <label>Watched <input type="checkbox" id="movieWatched"></label>
          </div>
          <div>
            <input type="text" id="movieReview" placeholder="Review (optional)">
          </div>
          <button type="submit" class="action-btn">Add Movie</button>
        </form>
      </div>
      <div class="card">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h2 style="margin: 0;">Movies</h2>
          <span id="movieCount" style="font-weight: bold;"></span>
        </div>
        <div style="display:flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
          <input type="text" id="movieSearch" placeholder="Search by title or director" style="flex: 2; min-width: 200px;">
          <select id="movieSort" style="flex: 1; min-width: 200px;">
            <option value="">Sort by...</option>
            <option value="rating-asc">Rating (Low ‚Üí High)</option>
            <option value="rating-desc">Rating (High ‚Üí Low)</option>
            <option value="year-asc">Year (Oldest ‚Üí Newest)</option>
            <option value="year-desc">Year (Newest ‚Üí Oldest)</option>
          </select>
          <button id="loadMovies" class="action-btn" style="flex: 1; min-width: 120px;">Load Movies</button>
          <button id="exportMovies" class="action-btn" style="flex: 1; min-width: 120px; background-color: #4caf50;">Export Data</button>
          <button id="importMovies" class="action-btn" style="flex: 1; min-width: 120px; background-color: #ff9800;">Import Data</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;">
        <table id="movieTable">
          <thead>
            <tr>
              <th>Poster</th>
              <th>Title</th>
              <th>Director</th>
              <th>Year</th>
              <th>Rating</th>
              <th>Watched</th>
              <th>Review</th>
              <th>IMDb</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- TV Shows Tab Content -->
    <div id="tv-shows-tab" class="tab-content">
      <div class="card">
        <h2>Add TV Show</h2>
        <form id="addTVShowForm">
          <div>
            <input type="text" id="tvTitle" placeholder="Title" required>
          </div>
          <div>
            <input type="number" id="tvYear" placeholder="Year" required>
          </div>
          <div>
            <input type="number" id="tvSeasons" placeholder="Seasons (optional)">
          </div>
          <div>
            <input type="number" id="tvEpisodes" placeholder="Episodes (optional)">
          </div>
          <div>
            <input type="number" min="0" max="10" id="tvRating" placeholder="Rating (0-10)">
          </div>
          <div>
            <label>Watched <input type="checkbox" id="tvWatched"></label>
          </div>
          <div>
            <input type="text" id="tvReview" placeholder="Review (optional)">
          </div>
          <button type="submit" class="action-btn">Add TV Show</button>
        </form>
      </div>
      <div class="card">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h2 style="margin: 0;">TV Shows</h2>
          <span id="tvShowCount" style="font-weight: bold;"></span>
        </div>
        <div style="display:flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
          <input type="text" id="tvSearch" placeholder="Search by title" style="flex: 2; min-width: 200px;">
          <select id="tvSort" style="flex: 1; min-width: 200px;">
            <option value="">Sort by...</option>
            <option value="rating-asc">Rating (Low ‚Üí High)</option>
            <option value="rating-desc">Rating (High ‚Üí Low)</option>
            <option value="year-asc">Year (Oldest ‚Üí Newest)</option>
            <option value="year-desc">Year (Newest ‚Üí Oldest)</option>
          </select>
          <button id="loadTVShows" class="action-btn" style="flex: 1; min-width: 120px;">Load TV Shows</button>
          <button id="exportTVShows" class="action-btn" style="flex: 1; min-width: 120px; background-color: #4caf50;">Export Data</button>
          <button id="importTVShows" class="action-btn" style="flex: 1; min-width: 120px; background-color: #ff9800;">Import Data</button>
        </div>
        <input type="file" id="importTVFile" accept=".json" style="display: none;">
        <table id="tvShowTable">
          <thead>
            <tr>
              <th>Poster</th>
              <th>Title</th>
              <th>Year</th>
              <th>Seasons</th>
              <th>Episodes</th>
              <th>Rating</th>
              <th>Watched</th>
              <th>Review</th>
              <th>IMDb</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Statistics Tab Content -->
    <div id="statistics-tab" class="tab-content">
      <div class="card">
        <h2>üìä Statistics Dashboard</h2>
        <div id="statsLoading" style="text-align: center; padding: 20px;">
          <p>Loading statistics...</p>
        </div>
        <div id="statsContent" style="display: none;">
          <!-- Watch Statistics -->
          <div class="stats-section">
            <h3>üìà Watch Progress</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="totalItems">0</div>
                <div class="stat-label">Total Items</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="watchedItems">0</div>
                <div class="stat-label">Watched</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="unwatchedItems">0</div>
                <div class="stat-label">Unwatched</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="completionPercentage">0%</div>
                <div class="stat-label">Completion</div>
              </div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <!-- Rating Statistics -->
          <div class="stats-section">
            <h3>‚≠ê Rating Analysis</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="averageRating">0.0</div>
                <div class="stat-label">Average Rating</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalRatedItems">0</div>
                <div class="stat-label">Rated Items</div>
              </div>
            </div>
            <div class="rating-distribution">
              <h4>Rating Distribution</h4>
              <div id="ratingBars"></div>
            </div>
            <div class="top-rated">
              <h4>üèÜ Highest Rated</h4>
              <div id="highestRatedList"></div>
            </div>
          </div>

          <!-- Year Statistics -->
          <div class="stats-section">
            <h3>üìÖ Year Analysis</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="oldestYear">-</div>
                <div class="stat-label">Oldest Year</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="newestYear">-</div>
                <div class="stat-label">Newest Year</div>
              </div>
            </div>
            <div class="decade-stats">
              <h4>Decade Breakdown</h4>
              <div id="decadeBars"></div>
            </div>
          </div>

          <!-- Director Statistics -->
          <div class="stats-section">
            <h3>üé¨ Director Analysis</h3>
            <div class="director-stats">
              <div class="director-column">
                <h4>Most Prolific Directors</h4>
                <div id="topDirectorsList"></div>
              </div>
              <div class="director-column">
                <h4>Highest Rated Directors</h4>
                <div id="highestRatedDirectorsList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="./credentials.js"></script>
  <script>
    const isLocal = (location.protocol === 'file:' || location.origin === 'null' || location.origin === '');
    const API_BASE = isLocal ? 'http://127.0.0.1:8000' : '';

    let editingRowId = null;
    let editingRowElement = null;
    let currentTab = 'movies';

    // Tab switching functionality
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      currentTab = tabName;
      
      // Load data for the active tab
      if (tabName === 'movies') {
        loadMovies();
      } else if (tabName === 'tv-shows') {
        loadTVShows();
      } else if (tabName === 'statistics') {
        loadStatistics();
      }
    }

    function disableOtherRowButtons(currentRow, tableId) {
      const buttons = document.querySelectorAll(`#${tableId} button.action-btn`);
      buttons.forEach(btn => {
        const btnRow = btn.closest('tr');
        if (!btnRow.isSameNode(currentRow)) {
          btn.disabled = true;
        }
      });
    }

    function enableAllRowButtons(tableId) {
      const buttons = document.querySelectorAll(`#${tableId} button.action-btn`);
      buttons.forEach(btn => {
        btn.disabled = false;
      });
    }

    // Dark mode toggle
    document.getElementById('toggleMode').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const btn = document.getElementById('toggleMode');
      btn.textContent = document.body.classList.contains('dark-mode') ? 'Light Mode' : 'Night Mode';
    });

    // Movie functions
    async function loadMovies() {
      const search = document.getElementById('movieSearch').value;
      const sortVal = document.getElementById('movieSort').value;
      let sortField = '';
      let order = '';
      if (sortVal) {
        const parts = sortVal.split('-');
        sortField = parts[0];
        order = parts[1] || '';
      }
      let url = `${API_BASE}/movies/?`;
      if (search) url += `search=${encodeURIComponent(search)}&`;
      if (sortField) url += `sort_by=${encodeURIComponent(sortField)}&`;
      if (order) url += `order=${encodeURIComponent(order)}`;
      const res = await fetch(url);
      if (res.ok) {
        const movies = await res.json();
        const tbody = document.querySelector('#movieTable tbody');
        tbody.innerHTML = '';
        const countElem = document.getElementById('movieCount');
        if (countElem) countElem.textContent = `${movies.length} Movies`;
        movies.forEach((movie) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td id="movie-poster-${movie.id}"></td>
            <td>${movie.title}</td>
            <td>${movie.director}</td>
            <td>${movie.year}</td>
            <td>${movie.rating !== null && movie.rating !== undefined ? movie.rating + '/10' : ''}</td>
            <td>${movie.watched}</td>
            <td>${movie.review ? movie.review : ''}</td>
            <td><a href="https://www.imdb.com/find?q=${encodeURIComponent(movie.title)}" target="_blank">Search</a></td>
            <td>
              <button class="action-btn" onclick="enableMovieEdit(this, ${movie.id}, '${encodeURIComponent(movie.title)}', '${encodeURIComponent(movie.director)}', ${movie.year}, ${movie.rating ?? 'null'}, ${movie.watched}, '${movie.review ? encodeURIComponent(movie.review) : ''}')">Edit</button>
              <button class="action-btn" onclick="deleteMovie(${movie.id})">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
          
          // Display cached poster or fetch new one
          if (movie.poster_url) {
            displayMoviePoster(movie.id, movie.poster_url);
          } else if (OMDB_API_KEY) {
            fetchMoviePoster(movie.id, movie.title, movie.year);
          }
        });
      }
    }

    function displayMoviePoster(id, posterUrl) {
      const cell = document.getElementById(`movie-poster-${id}`);
      if (cell && posterUrl) {
        cell.innerHTML = `<img src="${posterUrl}" alt="Poster" style="width: 60px; max-height: 90px; object-fit: cover; border-radius: 4px;">`;
      }
    }

    async function fetchMoviePoster(id, title, year) {
      try {
        const url = `https://www.omdbapi.com/?t=${encodeURIComponent(title)}&y=${encodeURIComponent(year)}&apikey=${OMDB_API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.Poster && data.Poster !== 'N/A') {
          // Save the poster URL to the database
          await saveMoviePosterUrl(id, data.Poster);
          // Display the poster
          displayMoviePoster(id, data.Poster);
        }
      } catch (err) {
        console.error('Error fetching movie poster:', err);
      }
    }

    async function saveMoviePosterUrl(id, posterUrl) {
      try {
        await fetch(`${API_BASE}/movies/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ poster_url: posterUrl }),
        });
      } catch (err) {
        console.error('Error saving poster URL:', err);
      }
    }

    async function deleteMovie(id) {
      if (!confirm('Are you sure you want to delete this movie?')) return;
      const res = await fetch(`${API_BASE}/movies/${id}`, { method: 'DELETE' });
      if (res.ok) loadMovies();
    }

    window.enableMovieEdit = function (btn, id, encTitle, encDirector, year, rating, watched, encReview) {
      if (editingRowId !== null) return;
      editingRowId = id;
      const row = btn.closest('tr');
      editingRowElement = row;
      const title = decodeURIComponent(encTitle);
      const director = decodeURIComponent(encDirector);
      const ratingVal = (rating !== null && rating !== 'null') ? rating : '';
      const review = encReview ? decodeURIComponent(encReview) : '';
      row.cells[1].innerHTML = `<input type="text" id="edit-movie-title" value="${title}">`;
      row.cells[2].innerHTML = `<input type="text" id="edit-movie-director" value="${director}">`;
      row.cells[3].innerHTML = `<input type="number" id="edit-movie-year" value="${year}">`;
      row.cells[4].innerHTML = `<input type="number" min="0" max="10" id="edit-movie-rating" value="${ratingVal}">`;
      row.cells[5].innerHTML = `<input type="checkbox" id="edit-movie-watched" ${watched ? 'checked' : ''}>`;
      row.cells[6].innerHTML = `<input type="text" id="edit-movie-review" value="${review}">`;
      row.cells[8].innerHTML = `
        <button class="action-btn" onclick="saveMovieEdit(${id})">Save</button>
        <button class="action-btn" onclick="cancelMovieEdit()">Cancel</button>
      `;
      disableOtherRowButtons(row, 'movieTable');
    };

    window.saveMovieEdit = async function (id) {
      if (editingRowId !== id) return;
      const updated = {
        title: document.getElementById('edit-movie-title').value,
        director: document.getElementById('edit-movie-director').value,
        year: parseInt(document.getElementById('edit-movie-year').value, 10),
        watched: document.getElementById('edit-movie-watched').checked,
      };
      const ratingVal = document.getElementById('edit-movie-rating').value;
      if (ratingVal) updated.rating = parseInt(ratingVal, 10);
      const reviewVal = document.getElementById('edit-movie-review') ? document.getElementById('edit-movie-review').value : '';
      if (reviewVal !== undefined) updated.review = reviewVal;
      const res = await fetch(`${API_BASE}/movies/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated),
      });
      if (res.ok) {
        editingRowId = null;
        editingRowElement = null;
        enableAllRowButtons('movieTable');
        loadMovies();
      }
    };

    window.cancelMovieEdit = function () {
      editingRowId = null;
      editingRowElement = null;
      enableAllRowButtons('movieTable');
      loadMovies();
    };

    // TV Show functions
    async function loadTVShows() {
      const search = document.getElementById('tvSearch').value;
      const sortVal = document.getElementById('tvSort').value;
      let sortField = '';
      let order = '';
      if (sortVal) {
        const parts = sortVal.split('-');
        sortField = parts[0];
        order = parts[1] || '';
      }
      let url = `${API_BASE}/tv-shows/?`;
      if (search) url += `search=${encodeURIComponent(search)}&`;
      if (sortField) url += `sort_by=${encodeURIComponent(sortField)}&`;
      if (order) url += `order=${encodeURIComponent(order)}`;
      const res = await fetch(url);
      if (res.ok) {
        const tvShows = await res.json();
        const tbody = document.querySelector('#tvShowTable tbody');
        tbody.innerHTML = '';
        const countElem = document.getElementById('tvShowCount');
        if (countElem) countElem.textContent = `${tvShows.length} TV Shows`;
        tvShows.forEach((tvShow) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td id="tv-poster-${tvShow.id}"></td>
            <td>${tvShow.title}</td>
            <td>${tvShow.year}</td>
            <td>${tvShow.seasons ?? ''}</td>
            <td>${tvShow.episodes ?? ''}</td>
            <td>${tvShow.rating !== null && tvShow.rating !== undefined ? tvShow.rating + '/10' : ''}</td>
            <td>${tvShow.watched}</td>
            <td>${tvShow.review ? tvShow.review : ''}</td>
            <td><a href="https://www.imdb.com/find?q=${encodeURIComponent(tvShow.title)}" target="_blank">Search</a></td>
            <td>
              <button class="action-btn" onclick="enableTVEdit(this, ${tvShow.id}, '${encodeURIComponent(tvShow.title)}', ${tvShow.year}, ${tvShow.seasons ?? 'null'}, ${tvShow.episodes ?? 'null'}, ${tvShow.rating ?? 'null'}, ${tvShow.watched}, '${tvShow.review ? encodeURIComponent(tvShow.review) : ''}')">Edit</button>
              <button class="action-btn" onclick="deleteTVShow(${tvShow.id})">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
          
          // Display cached poster or fetch new one
          if (tvShow.poster_url) {
            displayTVPoster(tvShow.id, tvShow.poster_url);
          } else if (OMDB_API_KEY) {
            fetchTVPoster(tvShow.id, tvShow.title, tvShow.year);
          }
        });
      }
    }

    function displayTVPoster(id, posterUrl) {
      const cell = document.getElementById(`tv-poster-${id}`);
      if (cell && posterUrl) {
        cell.innerHTML = `<img src="${posterUrl}" alt="Poster" style="width: 60px; max-height: 90px; object-fit: cover; border-radius: 4px;">`;
      }
    }

    async function fetchTVPoster(id, title, year) {
      try {
        const url = `https://www.omdbapi.com/?t=${encodeURIComponent(title)}&y=${encodeURIComponent(year)}&apikey=${OMDB_API_KEY}`;
        const res = await fetch(url);
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.Poster && data.Poster !== 'N/A') {
          // Save the poster URL to the database
          await saveTVPosterUrl(id, data.Poster);
          // Display the poster
          displayTVPoster(id, data.Poster);
        }
      } catch (err) {
        console.error('Error fetching TV show poster:', err);
      }
    }

    async function saveTVPosterUrl(id, posterUrl) {
      try {
        await fetch(`${API_BASE}/tv-shows/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ poster_url: posterUrl }),
        });
      } catch (err) {
        console.error('Error saving TV show poster URL:', err);
      }
    }

    async function deleteTVShow(id) {
      if (!confirm('Are you sure you want to delete this TV show?')) return;
      const res = await fetch(`${API_BASE}/tv-shows/${id}`, { method: 'DELETE' });
      if (res.ok) loadTVShows();
    }

    window.enableTVEdit = function (btn, id, encTitle, year, seasons, episodes, rating, watched, encReview) {
      if (editingRowId !== null) return;
      editingRowId = id;
      const row = btn.closest('tr');
      editingRowElement = row;
      const title = decodeURIComponent(encTitle);
      const ratingVal = (rating !== null && rating !== 'null') ? rating : '';
      const review = encReview ? decodeURIComponent(encReview) : '';
      row.cells[1].innerHTML = `<input type="text" id="edit-tv-title" value="${title}">`;
      row.cells[2].innerHTML = `<input type="number" id="edit-tv-year" value="${year}">`;
      row.cells[3].innerHTML = `<input type="number" id="edit-tv-seasons" value="${seasons !== 'null' ? seasons : ''}">`;
      row.cells[4].innerHTML = `<input type="number" id="edit-tv-episodes" value="${episodes !== 'null' ? episodes : ''}">`;
      row.cells[5].innerHTML = `<input type="number" min="0" max="10" id="edit-tv-rating" value="${ratingVal}">`;
      row.cells[6].innerHTML = `<input type="checkbox" id="edit-tv-watched" ${watched ? 'checked' : ''}>`;
      row.cells[7].innerHTML = `<input type="text" id="edit-tv-review" value="${review}">`;
      row.cells[9].innerHTML = `
        <button class="action-btn" onclick="saveTVEdit(${id})">Save</button>
        <button class="action-btn" onclick="cancelTVEdit()">Cancel</button>
      `;
      disableOtherRowButtons(row, 'tvShowTable');
    };

    window.saveTVEdit = async function (id) {
      if (editingRowId !== id) return;
      const updated = {
        title: document.getElementById('edit-tv-title').value,
        year: parseInt(document.getElementById('edit-tv-year').value, 10),
        watched: document.getElementById('edit-tv-watched').checked,
      };
      const seasonsVal = document.getElementById('edit-tv-seasons').value;
      if (seasonsVal) updated.seasons = parseInt(seasonsVal, 10);
      const episodesVal = document.getElementById('edit-tv-episodes').value;
      if (episodesVal) updated.episodes = parseInt(episodesVal, 10);
      const ratingVal = document.getElementById('edit-tv-rating').value;
      if (ratingVal) updated.rating = parseInt(ratingVal, 10);
      const reviewVal = document.getElementById('edit-tv-review') ? document.getElementById('edit-tv-review').value : '';
      if (reviewVal !== undefined) updated.review = reviewVal;
      const res = await fetch(`${API_BASE}/tv-shows/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated),
      });
      if (res.ok) {
        editingRowId = null;
        editingRowElement = null;
        enableAllRowButtons('tvShowTable');
        loadTVShows();
      }
    };

    window.cancelTVEdit = function () {
      editingRowId = null;
      editingRowElement = null;
      enableAllRowButtons('tvShowTable');
      loadTVShows();
    };

    // Form submissions
    document.getElementById('addMovieForm').onsubmit = async function (e) {
      e.preventDefault();
      const movie = {
        title: document.getElementById('movieTitle').value,
        director: document.getElementById('movieDirector').value,
        year: parseInt(document.getElementById('movieYear').value, 10),
        watched: document.getElementById('movieWatched').checked,
      };
      const ratingVal = document.getElementById('movieRating').value;
      if (ratingVal) movie.rating = parseInt(ratingVal, 10);
      const reviewVal = document.getElementById('movieReview').value;
      if (reviewVal) movie.review = reviewVal;
      const response = await fetch(`${API_BASE}/movies/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(movie),
      });
      if (response.ok) {
        document.getElementById('addMovieForm').reset();
        loadMovies();
      }
    };

    document.getElementById('addTVShowForm').onsubmit = async function (e) {
      e.preventDefault();
      const tvShow = {
        title: document.getElementById('tvTitle').value,
        year: parseInt(document.getElementById('tvYear').value, 10),
        watched: document.getElementById('tvWatched').checked,
      };
      const seasonsVal = document.getElementById('tvSeasons').value;
      if (seasonsVal) tvShow.seasons = parseInt(seasonsVal, 10);
      const episodesVal = document.getElementById('tvEpisodes').value;
      if (episodesVal) tvShow.episodes = parseInt(episodesVal, 10);
      const ratingVal = document.getElementById('tvRating').value;
      if (ratingVal) tvShow.rating = parseInt(ratingVal, 10);
      const reviewVal = document.getElementById('tvReview').value;
      if (reviewVal) tvShow.review = reviewVal;
      const response = await fetch(`${API_BASE}/tv-shows/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(tvShow),
      });
      if (response.ok) {
        document.getElementById('addTVShowForm').reset();
        loadTVShows();
      }
    };

    // Export/Import functions
    async function exportData() {
      try {
        const response = await fetch(`${API_BASE}/export/`);
        if (!response.ok) {
          throw new Error('Export failed');
        }
        
        const data = await response.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `streamtracker-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`Export successful! Exported ${data.export_metadata.total_movies} movies and ${data.export_metadata.total_tv_shows} TV shows.`);
      } catch (error) {
        alert('Export failed: ' + error.message);
      }
    }

    async function importData(fileInput) {
      const file = fileInput.files[0];
      if (!file) return;
      
      if (!file.name.endsWith('.json')) {
        alert('Please select a JSON file.');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch(`${API_BASE}/import/file/`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Import failed');
        }
        
        const result = await response.json();
        let message = `Import completed!\n`;
        message += `Movies: ${result.movies_created} created, ${result.movies_updated} updated\n`;
        message += `TV Shows: ${result.tv_shows_created} created, ${result.tv_shows_updated} updated`;
        
        if (result.errors.length > 0) {
          message += `\n\nErrors:\n${result.errors.join('\n')}`;
        }
        
        alert(message);
        
        // Refresh the current tab
        if (currentTab === 'movies') {
          loadMovies();
        } else if (currentTab === 'tv-shows') {
          loadTVShows();
        }
        
        // Clear the file input
        fileInput.value = '';
      } catch (error) {
        alert('Import failed: ' + error.message);
        fileInput.value = '';
      }
    }

    // Statistics functions
    async function loadStatistics() {
      try {
        document.getElementById('statsLoading').style.display = 'block';
        document.getElementById('statsContent').style.display = 'none';
        
        const response = await fetch(`${API_BASE}/statistics/`);
        if (!response.ok) {
          throw new Error('Failed to load statistics');
        }
        
        const stats = await response.json();
        displayStatistics(stats);
        
        document.getElementById('statsLoading').style.display = 'none';
        document.getElementById('statsContent').style.display = 'block';
      } catch (error) {
        console.error('Error loading statistics:', error);
        document.getElementById('statsLoading').innerHTML = '<p style="color: red;">Error loading statistics: ' + error.message + '</p>';
      }
    }

    function displayStatistics(stats) {
      // Watch statistics
      document.getElementById('totalItems').textContent = stats.watch_stats.total_items;
      document.getElementById('watchedItems').textContent = stats.watch_stats.watched_items;
      document.getElementById('unwatchedItems').textContent = stats.watch_stats.unwatched_items;
      document.getElementById('completionPercentage').textContent = stats.watch_stats.completion_percentage + '%';
      
      // Progress bar
      const progressFill = document.getElementById('progressFill');
      progressFill.style.width = stats.watch_stats.completion_percentage + '%';
      
      // Rating statistics
      document.getElementById('averageRating').textContent = stats.rating_stats.average_rating;
      document.getElementById('totalRatedItems').textContent = stats.rating_stats.total_rated_items;
      
      // Rating distribution
      displayRatingDistribution(stats.rating_stats.rating_distribution);
      
      // Highest rated items
      displayHighestRated(stats.rating_stats.highest_rated);
      
      // Year statistics
      document.getElementById('oldestYear').textContent = stats.year_stats.oldest_year || '-';
      document.getElementById('newestYear').textContent = stats.year_stats.newest_year || '-';
      
      // Decade statistics
      displayDecadeStats(stats.year_stats.decade_stats);
      
      // Director statistics
      displayTopDirectors(stats.director_stats.top_directors);
      displayHighestRatedDirectors(stats.director_stats.highest_rated_directors);
    }

    function displayRatingDistribution(distribution) {
      const container = document.getElementById('ratingBars');
      container.innerHTML = '';
      
      // Get all counts and find the maximum
      const counts = Object.values(distribution).map(Number);
      const maxCount = counts.length > 0 ? Math.max(...counts) : 1;
      
      for (let rating = 1; rating <= 10; rating++) {
        const count = distribution[rating.toString()] || 0;
        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
        
        const barDiv = document.createElement('div');
        barDiv.className = 'rating-bar';
        barDiv.innerHTML = `
          <div class="rating-bar-label">${rating}</div>
          <div class="rating-bar-fill" style="width: ${percentage}%"></div>
          <div class="rating-bar-count">${count}</div>
        `;
        container.appendChild(barDiv);
      }
    }

    function displayHighestRated(items) {
      const container = document.getElementById('highestRatedList');
      container.innerHTML = '';
      
      if (items.length === 0) {
        container.innerHTML = '<p>No rated items found.</p>';
        return;
      }
      
      items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'rated-item';
        itemDiv.innerHTML = `
          <div class="rated-item-title">${item.title} (${item.type})</div>
          <div class="rated-item-rating">${item.rating}/10</div>
        `;
        container.appendChild(itemDiv);
      });
    }

    function displayDecadeStats(decadeStats) {
      const container = document.getElementById('decadeBars');
      container.innerHTML = '';
      
      const decades = Object.keys(decadeStats).sort();
      
      // Calculate totals for each decade and find the maximum
      const totals = decades.map(decade => 
        (decadeStats[decade].movies || 0) + (decadeStats[decade].tv_shows || 0)
      );
      const maxCount = totals.length > 0 ? Math.max(...totals) : 1;
      
      decades.forEach(decade => {
        const total = (decadeStats[decade].movies || 0) + (decadeStats[decade].tv_shows || 0);
        const percentage = maxCount > 0 ? (total / maxCount) * 100 : 0;
        
        const barDiv = document.createElement('div');
        barDiv.className = 'decade-bar';
        barDiv.innerHTML = `
          <div class="decade-bar-label">${decade}</div>
          <div class="decade-bar-fill" style="width: ${percentage}%"></div>
          <div class="decade-bar-count">${total}</div>
        `;
        container.appendChild(barDiv);
      });
    }

    function displayTopDirectors(directors) {
      const container = document.getElementById('topDirectorsList');
      container.innerHTML = '';
      
      if (directors.length === 0) {
        container.innerHTML = '<p>No directors found.</p>';
        return;
      }
      
      directors.forEach(director => {
        const directorDiv = document.createElement('div');
        directorDiv.className = 'director-item';
        directorDiv.innerHTML = `
          <div class="director-name">${director.director}</div>
          <div class="director-rating">${director.count} movies</div>
        `;
        container.appendChild(directorDiv);
      });
    }

    function displayHighestRatedDirectors(directors) {
      const container = document.getElementById('highestRatedDirectorsList');
      container.innerHTML = '';
      
      if (directors.length === 0) {
        container.innerHTML = '<p>No rated directors found.</p>';
        return;
      }
      
      directors.forEach(director => {
        const directorDiv = document.createElement('div');
        directorDiv.className = 'director-item';
        directorDiv.innerHTML = `
          <div class="director-name">${director.director}</div>
          <div class="director-rating">${director.avg_rating}/10 (${director.count} movies)</div>
        `;
        container.appendChild(directorDiv);
      });
    }

    // Event listeners
    document.getElementById('loadMovies').addEventListener('click', loadMovies);
    document.getElementById('loadTVShows').addEventListener('click', loadTVShows);
    
    // Export/Import event listeners
    document.getElementById('exportMovies').addEventListener('click', exportData);
    document.getElementById('exportTVShows').addEventListener('click', exportData);
    document.getElementById('importMovies').addEventListener('click', () => document.getElementById('importFile').click());
    document.getElementById('importTVShows').addEventListener('click', () => document.getElementById('importTVFile').click());
    document.getElementById('importFile').addEventListener('change', (e) => importData(e.target));
    document.getElementById('importTVFile').addEventListener('change', (e) => importData(e.target));

    // Load initial data
    loadMovies();
  </script>
</body>
</html>